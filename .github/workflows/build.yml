name: Build MetaLens

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSVC Developer Environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Download ExifTool
      run: |
        echo Downloading ExifTool...
        curl.exe -L -o exiftool.zip "https://sourceforge.net/projects/exiftool/files/exiftool-13.51_64.zip/download" || curl.exe -L -o exiftool.zip "https://sourceforge.net/projects/exiftool/files/exiftool-13.50_64.zip/download"
      shell: cmd

    - name: Create Payload Zip
      run: |
        Expand-Archive -Path "exiftool.zip" -DestinationPath "exiftool_tmp" -Force
        # Find the inner directory e.g., exiftool-13.51_64
        $innerDir = Get-ChildItem -Path "exiftool_tmp" -Directory | Select-Object -First 1
        if ($innerDir) {
           # Rename exiftool(-k).exe to exiftool.exe
           $exe = Get-ChildItem -Path $innerDir.FullName -Filter "*.exe" | Select-Object -First 1
           if ($exe -and $exe.Name -ne "exiftool.exe") {
             Rename-Item -Path $exe.FullName -NewName "exiftool.exe"
           }
           # Compress the contents into payload.zip
           Compress-Archive -Path "$($innerDir.FullName)\*" -DestinationPath "src\payload.zip" -Force
           $sizeMB = [math]::Round((Get-Item "src\payload.zip").Length / 1MB, 2)
           Write-Host "Created src\payload.zip ($sizeMB MB)"
        } else {
           Write-Error "Could not find extracted directory"
           exit 1
        }
      shell: pwsh

    - name: Create output directory
      run: mkdir bin

    - name: Compile resource file (with embedded ExifTool)
      run: rc /nologo /dEMBED_EXIFTOOL /fo bin\resource.res src\resource.rc

    - name: Build MetaLens
      run: |
        cl /nologo /std:c++17 /O2 /EHsc /W3 ^
          /DUNICODE /D_UNICODE /D_WIN32_WINNT=0x0A00 ^
          /Isrc ^
          src\main.cpp ^
          bin\resource.res ^
          /Fe:bin\MetaLens.exe ^
          /link /SUBSYSTEM:WINDOWS ^
          comctl32.lib uxtheme.lib dwmapi.lib shlwapi.lib ^
          gdi32.lib user32.lib shell32.lib ole32.lib comdlg32.lib ^
          advapi32.lib
      shell: cmd

    - name: Clean intermediate files
      run: del /q *.obj 2>nul
      shell: cmd
      continue-on-error: true

    - name: Verify build
      run: |
        if (Test-Path "bin\MetaLens.exe") {
          $size = (Get-Item "bin\MetaLens.exe").Length / 1MB
          Write-Host "BUILD OK - MetaLens.exe ($([math]::Round($size, 2)) MB) - ExifTool embedded!"
        } else {
          Write-Error "BUILD FAILED"
          exit 1
        }

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: MetaLens-Windows-x64
        path: bin/MetaLens.exe
        retention-days: 90

    # --- Release steps (only on version tags) ---
    - name: Create release zip
      if: startsWith(github.ref, 'refs/tags/v')
      run: Compress-Archive -Path "bin\MetaLens.exe" -DestinationPath "MetaLens-${{ github.ref_name }}-windows-x64.zip"

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: MetaLens-*.zip
        generate_release_notes: true
        body: |
          ## MetaLens ${{ github.ref_name }}
          
          **Single exe â€” no setup needed!** ExifTool is embedded inside.
          
          ### How to use
          1. Download `MetaLens-${{ github.ref_name }}-windows-x64.zip` below
          2. Extract `MetaLens.exe`
          3. Run it and drop any photo, RAW file, or video!
          
          ### What's inside
          - 200+ camera model name resolution (Canon, Nikon, Sony, DJI, Samsung, etc.)
          - 150+ lens model identification
          - Full MakerNotes extraction
          - Search/filter across 1000+ metadata fields
