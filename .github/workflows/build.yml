name: Build MetaLens

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSVC Developer Environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Download ExifTool
      run: |
        echo Downloading ExifTool...
        curl.exe -L -o exiftool.zip "https://sourceforge.net/projects/exiftool/files/exiftool-13.51_64.zip/download" || curl.exe -L -o exiftool.zip "https://sourceforge.net/projects/exiftool/files/exiftool-13.50_64.zip/download"
        dir exiftool.zip
      shell: cmd

    - name: Extract ExifTool
      run: |
        Expand-Archive -Path "exiftool.zip" -DestinationPath "exiftool_tmp" -Force
        # Find the exe recursively (could be in subfolder)
        $exeFile = Get-ChildItem -Path "exiftool_tmp" -Filter "*.exe" -Recurse | Select-Object -First 1
        if ($exeFile -and $exeFile.Length -gt 3000000) {
          Copy-Item $exeFile.FullName -Destination "src\exiftool.exe" -Force
          $sizeMB = [math]::Round($exeFile.Length / 1MB, 2)
          Write-Host "ExifTool ready: $sizeMB MB -> src\exiftool.exe"
        } else {
          Write-Host "Archive contents:"
          Get-ChildItem -Path "exiftool_tmp" -Recurse | ForEach-Object { Write-Host "  $($_.FullName) ($($_.Length) bytes)" }
          Write-Error "ExifTool exe not found or too small"
          exit 1
        }
      shell: pwsh

    - name: Create output directory
      run: mkdir bin

    - name: Compile resource file (with embedded ExifTool)
      run: rc /nologo /dEMBED_EXIFTOOL /fo bin\resource.res src\resource.rc

    - name: Build MetaLens
      run: |
        cl /nologo /std:c++17 /O2 /EHsc /W3 ^
          /DUNICODE /D_UNICODE /D_WIN32_WINNT=0x0A00 ^
          /Isrc ^
          src\main.cpp ^
          bin\resource.res ^
          /Fe:bin\MetaLens.exe ^
          /link /SUBSYSTEM:WINDOWS ^
          comctl32.lib uxtheme.lib dwmapi.lib shlwapi.lib ^
          gdi32.lib user32.lib shell32.lib ole32.lib comdlg32.lib ^
          advapi32.lib
      shell: cmd

    - name: Clean intermediate files
      run: del /q *.obj 2>nul
      shell: cmd
      continue-on-error: true

    - name: Verify build
      run: |
        if (Test-Path "bin\MetaLens.exe") {
          $size = (Get-Item "bin\MetaLens.exe").Length / 1MB
          Write-Host "BUILD OK - MetaLens.exe ($([math]::Round($size, 2)) MB) - ExifTool embedded!"
        } else {
          Write-Error "BUILD FAILED"
          exit 1
        }

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: MetaLens-Windows-x64
        path: bin/MetaLens.exe
        retention-days: 90

    # --- Release steps (only on version tags) ---
    - name: Create release zip
      if: startsWith(github.ref, 'refs/tags/v')
      run: Compress-Archive -Path "bin\MetaLens.exe" -DestinationPath "MetaLens-${{ github.ref_name }}-windows-x64.zip"

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: MetaLens-*.zip
        generate_release_notes: true
        body: |
          ## MetaLens ${{ github.ref_name }}
          
          **Single exe â€” no setup needed!** ExifTool is embedded inside.
          
          ### How to use
          1. Download `MetaLens-${{ github.ref_name }}-windows-x64.zip` below
          2. Extract `MetaLens.exe`
          3. Run it and drop any photo, RAW file, or video!
          
          ### What's inside
          - 200+ camera model name resolution (Canon, Nikon, Sony, DJI, Samsung, etc.)
          - 150+ lens model identification
          - Full MakerNotes extraction
          - Search/filter across 1000+ metadata fields
